---
import Layout from "../../layouts/Layout.astro";
import { getPostBySlug, getPosts, getReviews, getListing } from "../../utils/directus.js";

const { slug } = Astro.params;

// 获取文章数据
const post = await getPostBySlug(slug);

if (!post) {
  Astro.response.status = 404;
  return Astro.redirect("/404");
}

const maleAuthors = [
  "Richard Whitman",
  "James Caldwell",
  "Edward Hastings",
  "Thomas Ridley",
  "Charles Pennington",
  "Walter Greaves",
  "Harold Beckett",
  "Franklin Morse",
  "Douglas Atwood",
  "Robert Ellsworth",
];

const femaleAuthors = [
  "Margaret Winslow",
  "Susan Ellery",
  "Elizabeth Crane",
  "Judith Carver",
  "Eleanor Prescott",
  "Diane Whitmore",
  "Clara Bainbridge",
  "Kathleen Foster",
  "Barbara Hollings",
  "Joanne Whitfield",
];

const allAuthors = [...maleAuthors, ...femaleAuthors];

// 随机选择一个作者
const randomIndex = Math.floor(Math.random() * allAuthors.length);
const randomAuthor = allAuthors[randomIndex];
const [firstName, lastName] = randomAuthor.split(" ");

// 获取昨天的日期
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
const formattedDate = yesterday.toLocaleDateString("en-US", {
  month: "long",
  day: "numeric",
  year: "numeric",
});

// 生成作者头像路径
const authorImagePath = `/author/${firstName}${lastName}.jpg`;

// 获取相关文章
const posts = await getPosts();
const relatedPosts = posts
  .filter(p => p.slug !== slug)
  .slice(0, 3);

// 获取推荐内容
let smartRecommendations = [];
const reviews = await getReviews();
for (const review of reviews.slice(0, 6)) {
  if (review.listing) {
    const listing = await getListing(review.listing);
    if (listing && listing.top1_pic && listing.top1_name && listing.top1_link) {
      smartRecommendations.push({
        name: listing.top1_name,
        image: `/uploads/${listing.top1_pic}`,
        link: listing.top1_link
      });
    }
  }
}
---

<Layout title={post.title}>
  <div class="max-w-5xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <header>
        <h1
          class="title text-3xl md:text-4xl lg:text-5xl font-bold text-gray-800 mb-4 tracking-wide leading-tight text-center"
        >
          {post.title}
        </h1>
        <div class="author flex items-center justify-center text-gray-600 mb-4">
          <img
            src={authorImagePath || "https://placehold.co/100x100"}
            alt={`${firstName} ${lastName}`}
            class="w-8 h-8 rounded-full mr-3 border border-gray-200"
          />
          <div class="flex items-center space-x-3">
            <p class="text-sm">
              By {firstName} {lastName}
            </p>
            <span class="text-gray-400">•</span>
            <p class="text-sm">{formattedDate}</p>
          </div>
        </div>
        {/* 文章主图 */}
        {post.image ? (
          <img
            src={post.image}
            alt={post.title}
            class="w-full rounded-lg"
            loading="lazy"
          />
        ) : (
          <div class="w-full h-[400px] bg-gradient-to-r from-orange-100 to-orange-200 rounded-lg"></div>
        )}
      </header>
      <section class="content py-4">
        <div>
          <div
            class="prose prose-lg max-w-none text-lg leading-relaxed text-gray-700"
            set:html={post.content}
          />
        </div>
      </section>
    </div>
    <div class="lg:col-span-1">
      <h2 class="text-2xl font-bold mb-6 text-gray-900">Recommendations</h2>
      <div class="bg-gray-50 rounded-lg p-6">
        <div class="space-y-4">
          {smartRecommendations.length > 0 ? (
            smartRecommendations.map(rec => (
              <div class="flex bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition items-center min-h-[90px]">
                <a 
                  href={rec.link}
                  class="flex-shrink-0 w-20 h-20 flex items-center justify-center group"
                >
                  <img 
                    src={rec.image} 
                    alt={rec.name} 
                    class="w-16 h-16 object-contain transition-transform group-hover:scale-105"
                  />
                </a>
                <div class="flex flex-col flex-1 justify-between h-full pl-4">
                  <a 
                    href={rec.link}
                    class="text-grey-600 font-medium text-sm group-hover:underline mb-2 line-clamp-2"
                  >
                    {rec.name}
                  </a>
                  <div class="flex-1"></div>
                  <div class="flex justify-end">
                    <a 
                      href={rec.link}
                      target="_blank"
                      class="inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-4 rounded transition-colors text-xs shadow group"
                    >
                      Visit Site
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div class="text-gray-400 text-center">No recommendations</div>
          )}
        </div>
      </div>
    </div>
  </div>
  <section class="related-posts py-8 bg-orange-50 opacity-800 w-full">
    <div class="max-w-5xl mx-auto px-4">
      <h2 class="text-2xl font-bold mb-6">Related Articles</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {relatedPosts.map(relatedPost => (
          <article class="bg-white rounded-lg shadow-md overflow-hidden">
            <a href={`/post/${relatedPost.slug}`}>
              <img
                src={relatedPost.image}
                alt={relatedPost.title}
                class="w-full h-48 object-cover"
              />
              <div class="p-4">
                <h3 class="text-lg font-semibold mb-2 hover:text-blue-600">
                  {relatedPost.title}
                </h3>
                <p class="text-gray-600 text-sm">
                  {relatedPost.excerpt}
                </p>
              </div>
            </a>
          </article>
        ))}
      </div>
    </div>
  </section>
</Layout> 